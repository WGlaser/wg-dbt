prefect-version: 2.17
name: wg-dbt

work_pools:
  central-push-pool: &central-push-pool
    name: central-push-pool
    job_variables:
      image: us-central1-docker.pkg.dev/wade-prefect/prefect-images/prefect-flows/wg-dbt
      memory: 1024Mi

build:
  - prefect.deployments.steps.run_shell_script:
      id: get-commit-hash
      script: git rev-parse --short HEAD
      stream_output: false
  - prefect_docker.deployments.steps.build_docker_image:
      id: build-image
      requires: prefect-docker
      image_name: us-central1-docker.pkg.dev/wade-prefect/prefect-images/prefect-flows/wg-dbt
      tag: "{{ get-commit-hash.stdout }}"
      dockerfile: Dockerfile
      platform: linux/amd64
      buildargs:
        AUTHED_ARTIFACT_REG_URL: "{{ prefect.blocks.secret.artifact-reg-url }}"
  - prefect_docker.deployments.steps.build_docker_image:
      id: build-image-latest
      requires: prefect-docker
      image_name: us-central1-docker.pkg.dev/wade-prefect/prefect-images/prefect-flows/wg-dbt
      tag: latest
      dockerfile: Dockerfile
      platform: linux/amd64
      buildargs:
        AUTHED_ARTIFACT_REG_URL: "{{ prefect.blocks.secret.artifact-reg-url }}"
push:
  - prefect_docker.deployments.steps.push_docker_image:
      requires: prefect-docker
      image_name: "{{build-image.image_name}}"
      tag: "{{ build-image.tag }}"
  - prefect_docker.deployments.steps.push_docker_image:
      requires: prefect-docker
      image_name: "{{build-image.image_name}}"
      tag: latest
pull:
  - prefect.deployments.steps.git_clone:
      repository: https://github.com/WGlaser/wg-dbt.git
      branch: main
      credentials: "{{ prefect.blocks.github-credentials.wg-github-credentials }}"
deployments:
- name: seatgeek
  tags: [seatgeek]
  entrypoint: lz_dbt/lz_dbt.py:lz_dbt
  parameters:
    api_name: seatgeek
    run: True
  work_pool: *central-push-pool
